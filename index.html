<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Asistente Virtual UCASAL</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#1e3a8a 0%,#3b82f6 100%);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
    .chat-container{width:100%;max-width:800px;height:600px;background:#fff;border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,.1);display:flex;flex-direction:column;overflow:hidden}
    .header{background:linear-gradient(90deg,#1e3a8a,#2563eb);color:#fff;padding:20px;text-align:center;position:relative}
    .header::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#fbbf24,#f59e0b)}
    .header h1{font-size:1.5rem;margin-bottom:5px}
    .header p{font-size:.9rem;opacity:.9}
    .messages-container{flex:1;overflow-y:auto;padding:20px;background:#f8fafc}
    .message{margin-bottom:15px;display:flex;align-items:flex-start;gap:10px}
    .message.user{justify-content:flex-end}
    .message.assistant{justify-content:flex-start}
    .message-content{max-width:70%;padding:12px 16px;border-radius:18px;line-height:1.4}
    .message.user .message-content{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;border-bottom-right-radius:5px}
    .message.assistant .message-content{background:#fff;border:1px solid #e2e8f0;border-bottom-left-radius:5px;box-shadow:0 2px 4px rgba(0,0,0,.05)}
    .avatar{width:35px;height:35px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;flex-shrink:0}
    .user .avatar{background:linear-gradient(135deg,#10b981,#059669)}
    .assistant .avatar{background:linear-gradient(135deg,#1e3a8a,#2563eb)}
    .input-container{padding:20px;background:#fff;border-top:1px solid #e2e8f0;display:flex;gap:10px;align-items:center}
    #messageInput{flex:1;padding:12px 16px;border:2px solid #e2e8f0;border-radius:25px;outline:none;font-size:14px;transition:border-color .3s}
    #messageInput:focus{border-color:#2563eb}
    #sendButton{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;border:none;width:45px;height:45px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:transform .2s}
    #sendButton:hover{transform:scale(1.05)} #sendButton:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .typing{display:flex;align-items:center;gap:4px;padding:12px 16px}
    .typing-dot{width:8px;height:8px;border-radius:50%;background:#64748b;animation:typing 1.4s infinite}
    .typing-dot:nth-child(2){animation-delay:.2s}.typing-dot:nth-child(3){animation-delay:.4s}
    @keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-10px)}}
    .assistant-info{font-size:12px;color:#64748b;text-align:center;margin:10px 0;padding:8px;background:rgba(37,99,235,.1);border-radius:8px}
    .error{color:#dc2626;background:#fee2e2;border:1px solid #fecaca;padding:12px;border-radius:8px;margin:10px 0}
    @media (max-width:768px){body{padding:10px}.chat-container{height:calc(100vh - 20px);border-radius:10px}.message-content{max-width:85%}}
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="header">
      <h1>Asistente Virtual UCASAL</h1>
      <p id="courseTag">Universidad Católica de Salta</p>
    </div>

    <div class="messages-container" id="messages">
      <div class="message assistant">
        <div class="avatar">AI</div>
        <div class="message-content">
          ¡Hola! Soy tu asistente virtual de UCASAL. Te ayudo con contenidos de la materia. ¿En qué puedo asistirte?
        </div>
      </div>
    </div>

    <div class="input-container">
      <input type="text" id="messageInput" placeholder="Escribe tu pregunta aquí..." maxlength="500"/>
      <button id="sendButton" type="button" aria-label="Enviar">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
             xmlns="http://www.w3.org/2000/svg"><path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="currentColor"/></svg>
      </button>
    </div>
  </div>

  <script>
    const url = new URL(location.href);
    const ASST = url.searchParams.get('asst') || '';
    const TITLE = url.searchParams.get('title') || '';
    if (TITLE) document.getElementById('courseTag').textContent = TITLE;

    class ChatUI {
      constructor() {
        this.$messages = document.getElementById('messages');
        this.$input = document.getElementById('messageInput');
        this.$send = document.getElementById('sendButton');
        this.bind();
      }
      bind() {
        this.$send.addEventListener('click', () => this.submit());
        this.$input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.submit(); }
        });
      }
      add(role, text) {
        const el = document.createElement('div');
        el.className = `message ${role}`;
        const avatar = role === 'user' ? 'U' : 'AI';
        el.innerHTML = `<div class="avatar">${avatar}</div><div class="message-content">${this.format(text)}</div>`;
        this.$messages.appendChild(el);
        this.$messages.scrollTop = this.$messages.scrollHeight;
      }
      format(t) { return String(t).replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); }
      typingStart() {
        const el = document.createElement('div');
        el.className = 'message assistant typing-message';
        el.innerHTML = `<div class="avatar">AI</div>
          <div class="message-content"><div class="typing">
              <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
          </div></div>`;
        this.$messages.appendChild(el);
        this.$messages.scrollTop = this.$messages.scrollHeight;
        return el;
      }
      typingStop(el) { if (el?.parentNode) el.parentNode.removeChild(el); }
      async submit() {
        const text = this.$input.value.trim();
        if (!text) return;
        this.$input.value = '';
        this.add('user', text);
        const typing = this.typingStart();
        this.$send.disabled = true; this.$input.disabled = true;
        try {
          const res = await fetch('/.netlify/functions/assistant', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text, asst: ASST })
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data?.error?.message || JSON.stringify(data));
          this.typingStop(typing);
          this.add('assistant', data.text || '(sin texto)');
        } catch (err) {
          console.error(err);
          this.typingStop(typing);
          this.add('assistant', 'Ocurrió un error al consultar el asistente. Reintentá en unos segundos.');
        } finally {
          this.$send.disabled = false; this.$input.disabled = false; this.$input.focus();
        }
      }
    }
    new ChatUI();
  </script>
</body>
</html>
